from PhysicsTools.NanoAODTools.postprocessing.framework.eventloop import Module
from PhysicsTools.NanoAODTools.postprocessing.framework.datamodel import Collection

class Edge_ZZkfactor( Module ):
    def __init__(self):
        pass
    def beginFile(self, inputFile, outputFile, inputTree, wrappedOutputTree):
        self.out = wrappedOutputTree
        self.out.branch('kfactor_pt_4l', 'F')
        self.out.branch('kfactor_mass_4l', 'F')
        self.out.branch('kfactor_pt_2l', 'F')
        self.out.branch('kfactor_mass_2l', 'F')

    def analyze(self, event):
#        gens = [ g for g in Collection(event, 'GenPart') if g.pdgId == 23 and g.statusFlags == 4481]
#        
#        if len(gens) != 2: 
#            kfactor_pt = 1 
#            kfactor_mass = 1 
#        else: 
#            mass = (gens[0].p4()+gens[1].p4()).M()
#            pt   = (gens[0].p4()+gens[1].p4()).Pt()
        kfactor_mass_4l = (1.23613*(abs(event.GENmassZZ_Edge)>0.0 and abs(event.GENmassZZ_Edge)<=25.0)+1.1755*(abs(event.GENmassZZ_Edge)>25.0  and abs(event.GENmassZZ_Edge)<=50.0 )+ 1.1704*(abs(event.GENmassZZ_Edge)>50.0  and abs(event.GENmassZZ_Edge)<=75.0 )+ 1.0314*(abs(event.GENmassZZ_Edge)>75.0  and abs(event.GENmassZZ_Edge)<=100.0)+1.0528*(abs(event.GENmassZZ_Edge)>100.0 and abs(event.GENmassZZ_Edge)<=125.0)+1.1128*(abs(event.GENmassZZ_Edge)>125.0 and abs(event.GENmassZZ_Edge)<=150.0)+1.1336*(abs(event.GENmassZZ_Edge)>150.0 and abs(event.GENmassZZ_Edge)<=175.0)+1.1035*(abs(event.GENmassZZ_Edge)>175.0 and abs(event.GENmassZZ_Edge)<=200.0)+1.1005*(abs(event.GENmassZZ_Edge)>200.0 and abs(event.GENmassZZ_Edge)<=225.0)+1.1097*(abs(event.GENmassZZ_Edge)>225.0 and abs(event.GENmassZZ_Edge)<=250.0)+1.1206*(abs(event.GENmassZZ_Edge)>250.0 and abs(event.GENmassZZ_Edge)<=275.0)+1.1158*(abs(event.GENmassZZ_Edge)>275.0 and abs(event.GENmassZZ_Edge)<=300.0)+1.1390*(abs(event.GENmassZZ_Edge)>300.0 and abs(event.GENmassZZ_Edge)<=325.0)+1.1485*(abs(event.GENmassZZ_Edge)>325.0 and abs(event.GENmassZZ_Edge)<=350.0)+1.1461*(abs(event.GENmassZZ_Edge)>350.0 and abs(event.GENmassZZ_Edge)<=375.0)+1.1457*(abs(event.GENmassZZ_Edge)>375.0 and abs(event.GENmassZZ_Edge)<=400.0)+1.1382*(abs(event.GENmassZZ_Edge)>400.0 and abs(event.GENmassZZ_Edge)<=425.0)+1.1552*(abs(event.GENmassZZ_Edge)>425.0 and abs(event.GENmassZZ_Edge)<=450.0)+1.1367*(abs(event.GENmassZZ_Edge)>450.0 and abs(event.GENmassZZ_Edge)<=475.0))+1.1322*(abs(event.GENmassZZ_Edge)>475.0)
        kfactor_pt_4l = (0.64155*(abs(event.GENptZZ_Edge)>0.0 and abs(event.GENptZZ_Edge)<=5.0)+1.0998*(abs(event.GENptZZ_Edge)>5.0  and abs(event.GENptZZ_Edge)<=10.0) +1.2939*(abs(event.GENptZZ_Edge)>10.0 and abs(event.GENptZZ_Edge)<=15.0)+1.3785*(abs(event.GENptZZ_Edge)>15.0 and abs(event.GENptZZ_Edge)<=20.0)+1.4243*(abs(event.GENptZZ_Edge)>20.0 and abs(event.GENptZZ_Edge)<=25.0)+1.4503*(abs(event.GENptZZ_Edge)>25.0 and abs(event.GENptZZ_Edge)<=30.0)+1.4701*(abs(event.GENptZZ_Edge)>30.0 and abs(event.GENptZZ_Edge)<=35.0)+1.4882*(abs(event.GENptZZ_Edge)>35.0 and abs(event.GENptZZ_Edge)<=40.0)+1.5057*(abs(event.GENptZZ_Edge)>40.0 and abs(event.GENptZZ_Edge)<=45.0)+1.5021*(abs(event.GENptZZ_Edge)>45.0 and abs(event.GENptZZ_Edge)<=50.0)+1.5091*(abs(event.GENptZZ_Edge)>50.0 and abs(event.GENptZZ_Edge)<=55.0)+1.5246*(abs(event.GENptZZ_Edge)>55.0 and abs(event.GENptZZ_Edge)<=60.0)+1.5240*(abs(event.GENptZZ_Edge)>60.0 and abs(event.GENptZZ_Edge)<=65.0)+1.5241*(abs(event.GENptZZ_Edge)>65.0 and abs(event.GENptZZ_Edge)<=70.0)+1.5542*(abs(event.GENptZZ_Edge)>70.0 and abs(event.GENptZZ_Edge)<=75.0)+1.5254*(abs(event.GENptZZ_Edge)>75.0 and abs(event.GENptZZ_Edge)<=80.0)+1.5789*(abs(event.GENptZZ_Edge)>80.0 and abs(event.GENptZZ_Edge)<=85.0)+1.5303*(abs(event.GENptZZ_Edge)>85.0 and abs(event.GENptZZ_Edge)<=90.0)+1.5614*(abs(event.GENptZZ_Edge)>90.0 and abs(event.GENptZZ_Edge)<=95.0)+1.5446*(abs(event.GENptZZ_Edge)>95.0 and abs(event.GENptZZ_Edge)<=100.0)+1.5722*(abs(event.GENptZZ_Edge)>100.0))
        kfactor_mass_2l = (1.25094*(abs(event.GENmassZZ_Edge)>0.0 and abs(event.GENmassZZ_Edge)<=25.0)+1.2245*(abs(event.GENmassZZ_Edge)>25.0  and abs(event.GENmassZZ_Edge)<=50.0 )+1.1928*(abs(event.GENmassZZ_Edge)>50.0  and abs(event.GENmassZZ_Edge)<=75.0 )+1.0459*(abs(event.GENmassZZ_Edge)>75.0  and abs(event.GENmassZZ_Edge)<=100.0)+1.0832*(abs(event.GENmassZZ_Edge)>100.0 and abs(event.GENmassZZ_Edge)<=125.0)+1.0999*(abs(event.GENmassZZ_Edge)>125.0 and abs(event.GENmassZZ_Edge)<=150.0)+1.1669*(abs(event.GENmassZZ_Edge)>150.0 and abs(event.GENmassZZ_Edge)<=175.0)+1.1039*(abs(event.GENmassZZ_Edge)>175.0 and abs(event.GENmassZZ_Edge)<=200.0)+1.1059*(abs(event.GENmassZZ_Edge)>200.0 and abs(event.GENmassZZ_Edge)<=225.0)+1.1069*(abs(event.GENmassZZ_Edge)>225.0 and abs(event.GENmassZZ_Edge)<=250.0)+1.1119*(abs(event.GENmassZZ_Edge)>250.0 and abs(event.GENmassZZ_Edge)<=275.0)+1.1352*(abs(event.GENmassZZ_Edge)>275.0 and abs(event.GENmassZZ_Edge)<=300.0)+1.1189*(abs(event.GENmassZZ_Edge)>300.0 and abs(event.GENmassZZ_Edge)<=325.0)+1.1389*(abs(event.GENmassZZ_Edge)>325.0 and abs(event.GENmassZZ_Edge)<=350.0)+1.1546*(abs(event.GENmassZZ_Edge)>350.0 and abs(event.GENmassZZ_Edge)<=375.0)+1.1734*(abs(event.GENmassZZ_Edge)>375.0 and abs(event.GENmassZZ_Edge)<=400.0)+1.2009*(abs(event.GENmassZZ_Edge)>400.0 and abs(event.GENmassZZ_Edge)<=425.0)+1.1891*(abs(event.GENmassZZ_Edge)>425.0 and abs(event.GENmassZZ_Edge)<=450.0)+1.1854*(abs(event.GENmassZZ_Edge)>450.0 and abs(event.GENmassZZ_Edge)<=475.0)+1.12864*(abs(event.GENmassZZ_Edge)>475.0))
        kfactor_pt_2l = (0.7436*(abs(event.GENptZZ_Edge)>0.0 and abs(event.GENptZZ_Edge)<=5.0)+1.14789*(abs(event.GENptZZ_Edge)>5.0 and abs(event.GENptZZ_Edge)<=10.0)+1.33815*(abs(event.GENptZZ_Edge)>10.0 and abs(event.GENptZZ_Edge)<=15.0)+1.41420*(abs(event.GENptZZ_Edge)>15.0 and abs(event.GENptZZ_Edge)<=20.0)+1.45511*(abs(event.GENptZZ_Edge)>20.0 and abs(event.GENptZZ_Edge)<=25.0)+1.47569*(abs(event.GENptZZ_Edge)>25.0 and abs(event.GENptZZ_Edge)<=30.0)+1.49053*(abs(event.GENptZZ_Edge)>30.0 and abs(event.GENptZZ_Edge)<=35.0)+1.50622*(abs(event.GENptZZ_Edge)>35.0 and abs(event.GENptZZ_Edge)<=40.0)+1.50328*(abs(event.GENptZZ_Edge)>40.0 and abs(event.GENptZZ_Edge)<=45.0)+1.52186*(abs(event.GENptZZ_Edge)>45.0 and abs(event.GENptZZ_Edge)<=50.0)+1.52043*(abs(event.GENptZZ_Edge)>50.0 and abs(event.GENptZZ_Edge)<=55.0)+1.53977*(abs(event.GENptZZ_Edge)>55.0 and abs(event.GENptZZ_Edge)<=60.0)+1.53491*(abs(event.GENptZZ_Edge)>60.0 and abs(event.GENptZZ_Edge)<=65.0)+1.51772*(abs(event.GENptZZ_Edge)>65.0 and abs(event.GENptZZ_Edge)<=70.0)+1.54494*(abs(event.GENptZZ_Edge)>70.0 and abs(event.GENptZZ_Edge)<=75.0)+1.57762*(abs(event.GENptZZ_Edge)>75.0 and abs(event.GENptZZ_Edge)<=80.0)+1.55078*(abs(event.GENptZZ_Edge)>80.0 and abs(event.GENptZZ_Edge)<=85.0)+1.57078*(abs(event.GENptZZ_Edge)>85.0 and abs(event.GENptZZ_Edge)<=90.0)+1.56162*(abs(event.GENptZZ_Edge)>90.0 and abs(event.GENptZZ_Edge)<=95.0)+1.54183*(abs(event.GENptZZ_Edge)>95.0 and abs(event.GENptZZ_Edge)<=100.0)+1.58485*(abs(event.GENptZZ_Edge)>100.0))

        self.out.fillBranch( 'kfactor_pt_4l'  , kfactor_pt_4l)
        self.out.fillBranch( 'kfactor_mass_4l', kfactor_mass_4l)
        self.out.fillBranch( 'kfactor_pt_2l'  , kfactor_pt_2l)
        self.out.fillBranch( 'kfactor_mass_2l', kfactor_mass_2l)
        return True
ZZkfactor = lambda : Edge_ZZkfactor()
